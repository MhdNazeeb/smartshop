<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />

    <title>Ekka - Ecommerce HTML Template.</title>
    <meta name="keywords"
        content="apparel, catalog, clean, ecommerce, ecommerce HTML, electronics, fashion, html eCommerce, html store, minimal, multipurpose, multipurpose ecommerce, online store, responsive ecommerce template, shops" />
    <meta name="description" content="Best ecommerce html template for single and multi vendor store." />
    <meta name="author" content="ashishmaraviya" />

    <!-- site Favicon -->
    <link rel="icon" href="/user/images/favicon/favicon.png" sizes="32x32" />
    <link rel="apple-touch-icon" href="/user/images/favicon/favicon.png" />
    <meta name="msapplication-TileImage" content="/user/images/favicon/favicon.png" />

    <!-- css Icon Font -->
    <link rel="stylesheet" href="/user/css/vendor/ecicons.min.css" />

    <!-- css All Plugins Files -->
    <link rel="stylesheet" href="/user/css/plugins/animate.css" />
    <link rel="stylesheet" href="/user/css/plugins/swiper-bundle.min.css" />
    <link rel="stylesheet" href="/user/css/plugins/jquery-ui.min.css" />
    <link rel="stylesheet" href="/user/css/plugins/countdownTimer.css" />
    <link rel="stylesheet" href="/user/css/plugins/slick.min.css" />
    <link rel="stylesheet" href="/user/css/plugins/nouislider.css" />
    <link rel="stylesheet" href="/user/css/plugins/bootstrap.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Main Style -->
    <link rel="stylesheet" href="/user/css/style.css" />
    <link rel="stylesheet" href="/user/css/responsive.css" />

    <!-- Background css -->
    <link rel="stylesheet" id="bg-switcher-css" href="/user/css/backgrounds/bg-4.css" />
</head>

<body class="checkout_page">
    <div id="ec-overlay"><span class="loader_img"></span></div>

    <!-- Header start  -->
    <%- include('./partials/navbar.ejs') %>
        <!-- ekka Cart End -->

        <!-- Ec breadcrumb start -->
        <div class="sticky-header-next-sec ec-breadcrumb section-space-mb">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="row ec_breadcrumb_inner">
                            <div class="col-md-6 col-sm-12">
                                <h2 class="ec-breadcrumb-title">Checkout</h2>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <!-- ec-breadcrumb-list start -->
                                <ul class="ec-breadcrumb-list">
                                    <li class="ec-breadcrumb-item">
                                        <a href="index.html">Home</a>
                                    </li>
                                    <li class="ec-breadcrumb-item active">Checkout</li>
                                </ul>
                                <!-- ec-breadcrumb-list end -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Ec breadcrumb end -->

        <!-- Ec checkout page -->
        <section class="ec-page-content section-space-p">
            <div class="container">
                <div class="row">
                    <div class="ec-checkout-leftside col-lg-8 col-md-12">
                        <!-- checkout content Start -->
                        <div class="ec-checkout-content">
                            <div class="ec-checkout-inner">
                                <!-- <div class="ec-checkout-wrap margin-bottom-30">
                                <div class="ec-checkout-block ec-check-new">
                                    <h3 class="ec-checkout-title">New Customer</h3>
                                    <div class="ec-check-block-content">
                                        <div class="ec-check-subtitle">Checkout Options</div>
                                        <form action="#">
                                            <span class="ec-new-option">
                                                <span>
                                                    <input type="radio" id="account1" name="radio-group" checked>
                                                    <label for="account1">Register Account</label>
                                                </span>
                                                <span>
                                                    <input type="radio" id="account2" name="radio-group">
                                                    <label for="account2">Guest Account</label>
                                                </span>
                                            </span>
                                        </form>
                                        <div class="ec-new-desc">By creating an account you will be able to shop faster,
                                            be up to date on an order's status, and keep track of the orders you have
                                            previously made.
                                        </div>
                                        <div class="ec-new-btn"><a href="#" class="btn btn-primary">Continue</a></div>

                                    </div>
                                </div>
                                <div class="ec-checkout-block ec-check-login">
                                    <h3 class="ec-checkout-title">Returning Customer</h3>
                                    <div class="ec-check-login-form">
                                        <form action="#" method="post">
                                            <span class="ec-check-login-wrap">
                                                <label>Email Address</label>
                                                <input type="text" name="name" placeholder="Enter your email address"
                                                    required />
                                            </span>
                                            <span class="ec-check-login-wrap">
                                                <label>Password</label>
                                                <input type="password" name="password" placeholder="Enter your password"
                                                    required />
                                            </span>

                                            <span class="ec-check-login-wrap ec-check-login-btn">
                                                <button class="btn btn-primary" type="submit">Login</button>
                                                <a class="ec-check-login-fp" href="#">Forgot Password?</a>
                                            </span>
                                        </form>
                                    </div>
                                </div>

                            </div> -->
                                <div class="ec-checkout-wrap margin-bottom-30 padding-bottom-3">
                                    <div class="ec-checkout-block ec-check-bill">
                                        <h3 class="ec-checkout-title">Billing Details</h3>
                                        <div class="ec-bl-block-content">
                                            <p>
                                                <a class="btn btn-primary" data-toggle="collapse"
                                                    href="#collapseExample" role="button" aria-expanded="true"
                                                    aria-controls="collapseExample">
                                                    Addresses
                                                </a>

                                                <!-- Button trigger modal -->
                                                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                                    data-bs-target="#staticBackdrop">
                                                    add address
                                                </button>

                                                <!-- Modal -->
                                            <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static"
                                                data-bs-keyboard="false" tabindex="-1"
                                                aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="staticBackdropLabel">Add address
                                                            </h5>
                                                            <button type="button" class="btn-close"
                                                                data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form class="row g-3 form" id="myForm">
                                                                <div class="col-md-12 space-t-15">
                                                                    <label class="form-label">name</label>
                                                                    <input type="text" name="name" class="form-control">
                                                                </div>

                                                                <div class="col-md-12 space-t-15">
                                                                    <label class="form-label">Address</label>
                                                                    <textarea class="form-control" name="address" id=""
                                                                        cols="50" rows="4"></textarea>
                                                                </div>
                                                                <div class="col-md-6 space-t-15">
                                                                    <label class="form-label">phone</label>
                                                                    <input type="tel" name="phone" maxlength="10"
                                                                        class="form-control">
                                                                </div>
                                                                <div class="col-md-6 space-t-15">
                                                                    <label class="form-label">State</label>
                                                                    <input type="text" name="state"
                                                                        class="form-control">
                                                                </div>
                                                                <div class="col-md-6 space-t-15">
                                                                    <label class="form-label">City</label>
                                                                    <input type="text" name="city" class="form-control">
                                                                </div>
                                                                <div class="col-md-6 space-t-15">
                                                                    <label class="form-label">pincode</label>
                                                                    <input type="text" name="pin" class="form-control">
                                                                </div>

                                                                <div class="col-md-12 space-t-15">
                                                                    <button type="submit" class="btn btn-primary"
                                                                        data-bs-dismiss="modal">Update</button>
                                                                    <a href=""
                                                                        class="btn btn-lg btn-secondary qty_close"
                                                                        data-bs-dismiss="modal"
                                                                        aria-label="Close">Close</a>
                                                                </div>
                                                            </form>

                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                            </p>
                                            <div class="collapse('show')" id="collapseExample">
                                                <div class="card card-body">
                                                    <% if(addresses==0){ %>
                                                        <div class="alert alert-success" role="alert">
                                                            Please Add address!
                                                        </div>
                                                        <% }else{ %>

                                                            <% for(let i=0 ;i<addresses.address.length;i++) { %>
                                                                <div class="col-lg-12 border"
                                                                    style="margin: 8px; width: 98% ; ">

                                                                    <span>
                                                                        <input type="radio" name="address"
                                                                            id="address<%= addresses.address[i]._id %>"
                                                                            value="<%= addresses.address[i]._id %>"
                                                                            style="margin-top: 10px;" checked>

                                                                        <label
                                                                            for="address<%= addresses.address[i]._id %>">select
                                                                            a address</label>
                                                                    </span>





                                                                    <h5>
                                                                        <%= addresses.address[i].name %>
                                                                    </h5>
                                                                    <li>
                                                                        <%= addresses.address[i].address %>
                                                                    </li>
                                                                    <li>
                                                                        <%= addresses.address[i].state %>
                                                                    </li>
                                                                    <li>
                                                                        <%= addresses.address[i].city %>
                                                                    </li>
                                                                    <li>
                                                                        <%= addresses.address[i].pin %>
                                                                    </li>
                                                                    <li>ph:<%= addresses.address[i].phone%>
                                                                    </li>





                                                                </div>


                                                                <% }} %>
                                                </div>
                                            </div>


                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                        <!--cart content End -->
                    </div>
                    <!-- Sidebar Area Start -->
                    <div class="ec-checkout-rightside col-lg-4 col-md-12">
                        <div class="ec-sidebar-wrap">
                            <!-- Sidebar Summary Block -->
                            <div class="ec-sidebar-block">
                                <div class="ec-sb-title">
                                    <h3 class="ec-sidebar-title">Summary</h3>
                                </div>
                                <div class="ec-sb-block-content">
                                    <div class="ec-checkout-summary">
                                        <div>
                                            <span class="text-left">Sub-Total</span>
                                            <span class="text-right">
                                                $<%= usercart.cartTotal %>
                                            </span>
                                        </div>
                                        <div>
                                            <span class="text-left">Delivery Charges</span>
                                            <span class="text-right">$50.00</span>
                                        </div>
                                        <div >
                                            <span class="text-left" id="discount" style="display: none;">Discount</span>
                                            <span class="text-right"   id="afterDiscount"></span>
                                        </div>
                                       
                                       
                                        <div>
                                            <span class="text-left">Coupan Discount</span>
                                            <span class="text-right"><a class="ec-checkout-coupan">Apply
                                                    Coupan</a></span>
                                        </div>
                                       
                                        <div class="ec-checkout-coupan-content" id="coupondiv">
                                            <form id="couponform" class="ec-checkout-coupan-form" name="ec-checkout-coupan-form"
                                                 >
                                               
                                                <input class="ec-coupan" type="text" id="couponcode"
                                                    placeholder="Enter Your Coupan Code" name="couponcode" />
                                                <input type="text" name="user" value="<%=userId%>" hidden> 
                                               
                                                <button class="ec-coupan-btn button btn-primary" type="submit"
                                                    name="subscribe" value="">
                                                    Apply
                                                </button>
                                            </form>
                                        </div>
                                        <div class="ec-checkout-summary-total">
                                            <span class="text-left">Total Amount</span>
                                            <span class="text-right" id="totalshow">
                                                $<%= usercart.cartTotal+50%>
                                            </span>
                                            <input type="number" name="total" id="total"
                                                value="<%= usercart.cartTotal+50%>" hidden>
                                        </div>
                                    </div>
                                    <!-- <div class="ec-checkout-pro">
                                    
                                    
                                </div> -->
                                </div>
                            </div>
                            <!-- Sidebar Summary Block -->
                        </div>
                        <div class="ec-sidebar-wrap ec-checkout-del-wrap">
                            <!-- Sidebar Summary Block -->
                            <div class="ec-sidebar-block">
                                <div class="ec-sb-title">
                                    <h3 class="ec-sidebar-title">Delivery Method</h3>
                                </div>
                                <div class="ec-sb-block-content">
                                    <div class="ec-checkout-del">
                                        <div class="ec-del-desc">Please select the preferred payment method to use on
                                            this
                                            order.</div>
                                        <form action="#">
                                            <span class="ec-del-option">
                                                <span>

                                                    <input type="radio" value="cod" id="del1" name="selector" checked>
                                                    <label for="del1">CASH ON DELIVERY</label>
                                                </span>
                                                <span>

                                                    <input type="radio" value="paypal" id="del2" name="selector">
                                                    <label for="del2">PAYPAL</label>
                                                </span>
                                            </span>

                                        </form>
                                        <div id="paypal-button-container">

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Sidebar Summary Block -->
                        </div>
                        <!-- <div class="ec-sidebar-wrap ec-checkout-pay-wrap"> -->
                        <!-- Sidebar Payment Block -->
                        <!-- <div class="ec-sidebar-block">
                                <div class="ec-sb-title">
                                    <h3 class="ec-sidebar-title">Payment Method</h3>
                                </div>
                                <div class="ec-sb-block-content">
                                    <div class="ec-checkout-pay">
                                        <div class="ec-pay-desc">
                                            Please select the preferred payment method to use on this
                                            order.
                                        </div>
                                        <form action="#">
                                            <span class="ec-pay-option">
                                                <span>
                                                    <input type="radio" id="cash" name="group1" checked="true" />
                                                    <label for="pay2">Cash On Delivery</label>
                                                </span>
                                                <span>
                                                    <input type="radio" id="paypal" name="group1"  />
                                                    <label for="pay2">paypal</label>
                                                </span>
                                            </span>


                                        </form>
                                    </div>
                                </div>
                            </div> -->
                        <!-- Sidebar Payment Block -->
                        <!-- </div> -->
                        <!-- <div class="ec-sidebar-wrap ec-check-pay-img-wrap"> -->
                        <!-- Sidebar Payment Block -->
                        <!-- <div class="ec-sidebar-block">
                            <div class="ec-sb-title">
                                <h3 class="ec-sidebar-title">Payment Method</h3>
                            </div>
                            <div class="ec-sb-block-content">
                                <div class="ec-check-pay-img-inner">
                                    <div class="ec-check-pay-img">
                                        <img src="/user/images/icons/payment1.png" alt="">
                                    </div>
                                    <div class="ec-check-pay-img">
                                        <img src="/user/images/icons/payment2.png" alt="">
                                    </div>
                                    <div class="ec-check-pay-img">
                                        <img src="/user/images/icons/payment3.png" alt="">
                                    </div>
                                    <div class="ec-check-pay-img">
                                        <img src="/user/images/icons/payment4.png" alt="">
                                    </div>
                                    <div class="ec-check-pay-img">
                                        <img src="/user/images/icons/payment5.png" alt="">
                                    </div>
                                    <div class="ec-check-pay-img">
                                        <img src="/user/images/icons/payment6.png" alt="">
                                    </div>
                                    <div class="ec-check-pay-img">
                                        <img src="/user/images/icons/payment7.png" alt="">
                                    </div>
                                </div>
                            </div>
                        </div> -->

                        <span class="ec-check-order-btn">
                            <% if(addresses==0){ %>
                                <button class="btn btn-primary" type="submit" hidden> place order</button>
                                <% }else {%>

                                    <button class="btn btn-primary" onclick="payment()" type="submit"> place
                                        order</button>
                                    <% } %>
                        </span>
                        <!-- Sidebar Payment Block -->
                        <!-- </div> -->
                    </div>
                </div>
            </div>
        </section>



        <!-- Footer Start -->
        <%- include('./partials/footer.ejs') %>
            <!-- Feature tools end -->
            <script>
                const myForm = document.getElementById("myForm");


                myForm.addEventListener("submit", (e) => {
                    e.preventDefault();
                    $.ajax({
                        url: "/address",
                        method: "post",
                        data: $("#myForm").serialize(),
                        success: (res) => {
                            console.log(res)
                        },

                    })

                })



                function payment() {
                    const address = $('input[type="radio"][name="address"]:checked').val();
                    const paymode = $('input[type="radio"][name="selector"]:checked').val();
                    const total = document.getElementById('total').value;
                    const discount = document.getElementById('afterDiscount').innerHTML            


                    $.ajax({
                        url: "/placeOrder",
                        method: "post",
                        data: {
                            address, paymode, total,discount
                        },
                        success: (res) => {
                            if (res.cod) {
                                Swal.fire({
                                    position: 'top-center',
                                    icon: 'success',
                                    title: 'Your order placed successfully',
                                    showConfirmButton: false,
                                    timer: 1000
                                }).then((res) => {


                                    location.href = "/success"

                                })

                            } else if (res.paypal) {
                                userOrderData = res.userOrderData
                                amount = res.walletBalance
                                console.log(amount, "aaaaaaaaaaaaaaaaaa")


                                paypal_sdk.Buttons({
                                    createOrder: function () {
                                        return fetch('/create-order', {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                            },
                                            body: JSON.stringify({
                                                items: [
                                                    {
                                                        id: 1,
                                                        amount: res.walletBalance,
                                                    },
                                                    { id: 2, amount: res.walletBalance },
                                                ],
                                            }),
                                        }).then(res => {

                                            if (res.ok) return res.json()
                                            console.log(res.json());

                                            return res.json().then(json => Promise.reject(json))
                                        }).then(({ id }) => {

                                            return id
                                        }).catch(e => {
                                            console.error(e)

                                        })
                                    },
                                    onApprove: function (data, actions) {
                                        console.log(data)
                                        console.log(actions);

                                        return actions.order.capture().then(function (details) {
                                            verifyPayment(res)
                                           
                                        })
                                    }
                                }).render('#paypal-button-container');
                            }
                        }
                    })

                }

                function verifyPayment(verifyData) {
                    console.log("verifyyyyyyyyyyyyyyyghghggghggh");


                    $.ajax({

                        url: '/verifypayment',
                        method: "post",
                        data: {
                            verifyData,
                        },
                        success: (res) => {

                            if (res.status) {

                                Swal.fire({
                                    position: 'top-center',
                                    icon: 'success',
                                    title: 'Your order placed successfully',
                                    showConfirmButton: false,
                                    timer: 1000
                                }).then((result) => {
                                    console.log("asdfghjklkjhgfdjiiiiiiiiiiii")


                                    location.href = "/success"

                                })
                            }

                        }





                    })


                }
           
                let clicked = false;
                    const couponForm = document.getElementById('couponform')
                    couponForm.addEventListener("submit", (e) => {
                    e.preventDefault();
                    var code = document.getElementById('couponcode').value
                     const carttotal = document.getElementById('total').value;
                    if(code == ''){
                        document.getElementById('').style.display = 'inline'
                        setTimeout(()=> document.getElementById('error').style.display ='none',2000)
                    }else{
                        $.ajax({
                            url:'/couponcheck',
                            method:'post',
                            dataType:'json',
                            encode : true,
                            data : $('#couponform').serialize()+ `&carttotal=${carttotal}`,
                            success:(res)=>{
                                if(res.status){
                                    console.log(res.totalprize)
                                    document.getElementById('discount').style.display="inline"
                                    document.getElementById('afterDiscount').innerHTML=res.discount
                                    document.getElementById('totalshow').innerHTML="$"+res.totalprize
                                    document.getElementById('total').value=res.totalprize;
                                    document.getElementById('total').innerHTML="$"+res.totalprize
                                    setTimeout(()=> document.getElementById('couponcode').value ="",2000)
                                    document.getElementById("coupondiv").style.display = "none";
                                }
                                else{
                                    console.log(res.message+33333333)

                                    document.getElementById("couponcode").style.color = "red";
                                    document.getElementById('couponcode').value=res.message
                                    setTimeout(()=> document.getElementById('couponcode').value ="",2000)
                                }
                            }
                        })
                    }

                    })
            </script>






            <!-- Vendor JS -->
            <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalclientid %>"
                data-namespace="paypal_sdk"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
            <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
                integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
                crossorigin="anonymous"></script>
            <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
                integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
                crossorigin="anonymous"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
                integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
                crossorigin="anonymous"></script>
            <script src="/user/js/vendor/jquery-3.5.1.min.js"></script>
            <script src="/user/js/vendor/popper.min.js"></script>
            <script src="/user/js/vendor/bootstrap.min.js"></script>
            <script src="/user/js/vendor/jquery-migrate-3.3.0.min.js"></script>
            <script src="/user/js/vendor/modernizr-3.11.2.min.js"></script>
            <script src="/user/js/vendor/bootstrap-tagsinput.js"></script>
            <script src="/user/js/vendor/jquery.magnific-popup.min.js"></script>

            <!--Plugins JS-->
            <script src="/user/js/plugins/swiper-bundle.min.js"></script>
            <script src="/user/js/plugins/countdownTimer.min.js"></script>
            <script src="/user/js/plugins/scrollup.js"></script>
            <script src="/user/js/plugins/jquery.zoom.min.js"></script>
            <script src="/user/js/plugins/slick.min.js"></script>
            <script src="/user/js/plugins/infiniteslidev2.js"></script>
            <script src="/user/js/vendor/jquery.magnific-popup.min.js"></script>
            <script src="/user/js/plugins/jquery.sticky-sidebar.js"></script>
            <script src="/user/js/plugins/nouislider.js"></script>

            <!-- Google translate Js -->
            <script src="/user/js/vendor/google-translate.js"></script>
            <script>
                function googleTranslateElementInit() {
                    new google.translate.TranslateElement(
                        { pageLanguage: "en" },
                        "google_translate_element"
                    );
                }
            </script>
            <!-- Main Js -->
            <script src="/user/js/vendor/index.js"></script>
            <script src="/user/js/main.js"></script>
</body>

</html>
